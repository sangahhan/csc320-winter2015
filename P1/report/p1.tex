%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Programming/Coding Assignment
% LaTeX Template
%
% This template has been downloaded from:
% http://www.latextemplates.com
%
% Original author:
% Ted Pavlic (http://www.tedpavlic.com)
%
% Note:
% The \lipsum[#] commands throughout this template generate dummy text
% to fill the template out. These commands should all be removed when 
% writing assignment content.
%
% This template uses a Perl script as an example snippet of code, most other
% languages are also usable. Configure them in the "CODE INCLUSION 
% CONFIGURATION" section.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%----------------------------------------------------------------------------------------
%   PACKAGES AND OTHER DOCUMENT CONFIGURATIONS
%----------------------------------------------------------------------------------------

\documentclass{article}

\usepackage{fancyhdr} % Required for custom headers
\usepackage{lastpage} % Required to determine the last page for the footer
\usepackage{extramarks} % Required for headers and footers
\usepackage[usenames,dvipsnames]{color} % Required for custom colors
\usepackage{graphicx} % Required to insert images
\usepackage{subcaption}
\usepackage{listings} % Required for insertion of code
\usepackage{courier} % Required for the courier font
\usepackage{lipsum} % Used for inserting dummy 'Lorem ipsum' text into the template

% Margins
\topmargin=-0.45in
\evensidemargin=0in
\oddsidemargin=0in
\textwidth=6.5in
\textheight=9.0in
\headsep=0.25in

\linespread{1.1} % Line spacing

% Set up the header and footer
\pagestyle{fancy}
\lhead{\hmwkAuthorName} % Top left header
\chead{\hmwkClass\ (\hmwkClassTime): \hmwkTitle} % Top center head
\rhead{\firstxmark} % Top right header
\lfoot{\lastxmark} % Bottom left footer
\cfoot{} % Bottom center footer
\rfoot{Page\ \thepage\ of\ \protect\pageref{LastPage}} % Bottom right footer
\renewcommand\headrulewidth{0.4pt} % Size of the header rule
\renewcommand\footrulewidth{0.4pt} % Size of the footer rule

\setlength\parindent{0pt} % Removes all indentation from paragraphs

%----------------------------------------------------------------------------------------
%   CODE INCLUSION CONFIGURATION
%----------------------------------------------------------------------------------------

\definecolor{MyDarkGreen}{rgb}{0.0,0.4,0.0} % This is the color used for comments
\lstloadlanguages{Perl} % Load Perl syntax for listings, for a list of other languages supported see: ftp://ftp.tex.ac.uk/tex-archive/macros/latex/contrib/listings/listings.pdf
\lstset{language=Perl, % Use Perl in this example
        frame=single, % Single frame around code
        basicstyle=\small\ttfamily, % Use small true type font
        keywordstyle=[1]\color{Blue}\bf, % Perl functions bold and blue
        keywordstyle=[2]\color{Purple}, % Perl function arguments purple
        keywordstyle=[3]\color{Blue}\underbar, % Custom functions underlined and blue
        identifierstyle=, % Nothing special about identifiers                                         
        commentstyle=\usefont{T1}{pcr}{m}{sl}\color{MyDarkGreen}\small, % Comments small dark green courier font
        stringstyle=\color{Purple}, % Strings are purple
        showstringspaces=false, % Don't put marks in string spaces
        tabsize=5, % 5 spaces per tab
        %
        % Put standard Perl functions not included in the default language here
        morekeywords={rand},
        %
        % Put Perl function parameters here
        morekeywords=[2]{on, off, interp},
        %
        % Put user defined functions here
        morekeywords=[3]{test},
        %
        morecomment=[l][\color{Blue}]{...}, % Line continuation (...) like blue comment
        numbers=left, % Line numbers on left
        firstnumber=1, % Line numbers start with line 1
        numberstyle=\tiny\color{Blue}, % Line numbers are blue and small
        stepnumber=5 % Line numbers go in steps of 5
}

% Creates a new command to include a perl script, the first parameter is the filename of the script (without .pl), the second parameter is the caption
\newcommand{\perlscript}[2]{
\begin{itemize}
\item[]\lstinputlisting[caption=#2,label=#1]{#1.pl}
\end{itemize}
}

%----------------------------------------------------------------------------------------
%   DOCUMENT STRUCTURE COMMANDS
%   Skip this unless you know what you're doing
%----------------------------------------------------------------------------------------

% Header and footer for when a page split occurs within a problem environment
\newcommand{\enterProblemHeader}[1]{
\nobreak\extramarks{#1}{#1 continued on next page\ldots}\nobreak
\nobreak\extramarks{#1 (continued)}{#1 continued on next page\ldots}\nobreak
}

% Header and footer for when a page split occurs between problem environments
\newcommand{\exitProblemHeader}[1]{
\nobreak\extramarks{#1 (continued)}{#1 continued on next page\ldots}\nobreak
\nobreak\extramarks{#1}{}\nobreak
}

\setcounter{secnumdepth}{0} % Removes default section numbers
\newcounter{homeworkProblemCounter} % Creates a counter to keep track of the number of problems
\setcounter{homeworkProblemCounter}{-1}
\newcommand{\homeworkProblemName}{}
\newenvironment{homeworkProblem}[1][Part \arabic{homeworkProblemCounter}]{ % Makes a new environment called homeworkProblem which takes 1 argument (custom name) but the default is "Problem #"
\stepcounter{homeworkProblemCounter} % Increase counter for number of problems
\renewcommand{\homeworkProblemName}{#1} % Assign \homeworkProblemName the name of the problem
\section{\homeworkProblemName} % Make a section in the document with the custom problem count
\enterProblemHeader{\homeworkProblemName} % Header and footer within the environment
}{
\exitProblemHeader{\homeworkProblemName} % Header and footer after the environment
}

\newcommand{\problemAnswer}[1]{ % Defines the problem answer command with the content as the only argument
\noindent\framebox[\columnwidth][c]{\begin{minipage}{0.98\columnwidth}#1\end{minipage}} % Makes the box around the problem answer and puts the content inside
}

\newcommand{\homeworkSectionName}{}
\newenvironment{homeworkSection}[1]{ % New environment for sections within homework problems, takes 1 argument - the name of the section
\renewcommand{\homeworkSectionName}{#1} % Assign \homeworkSectionName to the name of the section from the environment argument
\subsection{\homeworkSectionName} % Make a subsection with the custom name of the subsection
\enterProblemHeader{\homeworkProblemName\ [\homeworkSectionName]} % Header and footer within the environment
}{
\enterProblemHeader{\homeworkProblemName} % Header and footer after the environment
}

%----------------------------------------------------------------------------------------
%   NAME AND CLASS SECTION
%----------------------------------------------------------------------------------------

\newcommand{\hmwkTitle}{Assignment\ \#$1$} % Assignment title
\newcommand{\hmwkDueDate}{Saturday,\ January\ 24,\ 2015} % Due date
\newcommand{\hmwkClass}{CSC320} % Course/class
\newcommand{\hmwkClassTime}{L0501} % Class/lecture time
\newcommand{\hmwkAuthorName}{Sang-Ah Han} % Your name

%----------------------------------------------------------------------------------------
%   TITLE PAGE
%----------------------------------------------------------------------------------------

\title{
\vspace{2in}
\textmd{\textbf{\hmwkClass:\ \hmwkTitle}}\\
\normalsize\vspace{0.1in}\small{Due\ on\ \hmwkDueDate}\\
\vspace{0.1in}
\vspace{3in}
}

\author{\textbf{\hmwkAuthorName}}
%\date{} % Insert date here if you want it to appear below your name

%----------------------------------------------------------------------------------------

\newcommand{\displayImage}[2]{\includegraphics[scale=#2]{#1}}


%----------------------------------------------------------------------------------------

\begin{document}

\maketitle
\clearpage
%----------------------------------------------------------------------------------------
%   PROBLEM 1
%----------------------------------------------------------------------------------------

% To have just one problem per page, simply put a \clearpage after each problem

\begin{homeworkProblem}

\noindent \textit{Dataset description}

The dataset consists of images that contain 3 vertically stacked photos that have been taken in greyscale, but through blue, green, and red filters respectively. Four examples of these images are shown in  Figure~\ref{fig:sampleinput}.

\begin{figure*}[h!]
    \begin{center}
    \begin{subfigure}[b]{0.25\textwidth}
        \displayImage{00757v.jpg}{0.25}
        \caption{}
    \end{subfigure}%
    ~
    \begin{subfigure}[b]{0.25\textwidth}
        \displayImage{00106v.jpg}{0.25}
        \caption{}
    \end{subfigure}%
    ~
    \begin{subfigure}[b]{0.25\textwidth}
        \displayImage{00911v.jpg}{0.25}
        \caption{}
    \end{subfigure}%
    ~
    \begin{subfigure}[b]{0.25\textwidth}
        \displayImage{00907v.jpg}{0.25}
        \caption{}
    \end{subfigure}
    \end{center}
    \caption{Low-resolution sample input photos.}
    \label{fig:sampleinput}
\end{figure*}

To align the photos properly, the black borders around each photo must be taken into account when applying a patch matching method. Some of the input photos are lower-resolution \emph{.jpg} files, while others are higher-resolution \emph{.png} files.

\end{homeworkProblem}
\clearpage
%----------------------------------------------------------------------------------------
%   PROBLEM 2
%----------------------------------------------------------------------------------------

\begin{homeworkProblem}
\noindent \textit{Applying an algorithm: initial exploration.}

%Obtain the colour image for several examples by matching the inverted negatives using both NCC and SSD.ï¿¼In your report, indicate which seems to work better. Are there any artefacts in the output? What may explain the artefacts For Part 1, you may assume that the input image will be of size similar to that of 00757v.jpg

Using the low-resolution \emph{.jpg}'s from the given dataset of images, colour images were obtained using both \emph{Normalized Cross-Correlation} (NCC) and \emph{Sum of Square Differenced} (SSD) template matching methods.  

For the most part, the two methods, SSD and NCC, produced very similar results, as depicted in Figure~\ref{fig:part1outputa}, and in Figure~\ref{fig:part1outputd}

\begin{figure*}[h!]
    \begin{center}
        \displayImage{00757v_part1out.jpg}{0.5}
        \caption{Left: coloured version of Figure ~\ref{fig:sampleinput}(a), aligned with SSD. Right: coloured version of ~\ref{fig:sampleinput}(a), aligned with NCC.}
        \label{fig:part1outputa}
    \end{center}
\end{figure*}

\begin{figure*}[h!]
    \begin{center}
        \displayImage{00106v_part1out.jpg}{0.5}
        \caption{Left: coloured version of Figure ~\ref{fig:sampleinput}(b), aligned with SSD. Right: coloured version of ~\ref{fig:sampleinput}(b), aligned with NCC.}
        \label{fig:part1outputd}
    \end{center}
\end{figure*}

However, not all of the inputs produced perfect outputs, for various reason. One being the range of displacement used to test alignment of the photos-- this task specified to test alignment by displacing the photos 10 pixels each way (left, right, up and down) and obtaining the displacement with the best score. For some images, this score was best achieved with a displacement of more than 10 pixels, as shown in Figure~\ref{fig:part1outputc}.

\begin{figure*}

    \begin{subfigure}[b]{1\textwidth}
        \begin{center}
        \displayImage{00911v_part1out.jpg}{0.5}
        \caption{Left: coloured version of Figure~\ref{fig:sampleinput}(c), aligned with SSD. Right: coloured version of Figure~\ref{fig:sampleinput}(c), aligned with NCC. Both images checked for alignment for displacements up to 10 pixels.}
        \end{center}
    \end{subfigure}
    \begin{subfigure}[b]{1\textwidth}
        \begin{center}
        \displayImage{00911v_part1out2.jpg}{0.5}
        \caption{Left: coloured version of Figure~\ref{fig:sampleinput}(c), aligned with SSD. Right: coloured version of Figure~\ref{fig:sampleinput}(c), aligned with NCC. Both images checked for alignment for displacements up to 15 pixels.}
         \end{center}
    \end{subfigure}
\caption{}
\label{fig:part1outputc}
\end{figure*}

\clearpage

The resulting photos from applying both SSD and NCC in Figure~\ref{fig:part1outputc}(a) were not enough to align the images perfectly. It was only until the range of displacements to test alignments was increased (shown in Figure~\ref{fig:part1outputc}(b)) that it was possible to align them perfectly. 

Finally, there were some images for which the two methods did not yield similar results. Figure~\ref{fig:part1outputb} shows an example of this occurrence. Though SSD is more computationally efficient compared to NCC, SSD is also more sensitive to the intensity of the images being compared. NCC avoids this by subtracting the mean and dividing by the standard deviation for every point. 
\begin{figure*}[h!]
    \begin{center}
        \displayImage{00907v_part1out.jpg}{0.5}
        \caption{Left: coloured version of Figure ~\ref{fig:sampleinput}(b), aligned with SSD. Right: coloured version of ~\ref{fig:sampleinput}(b), aligned with NCC.}
        \label{fig:part1outputb}
    \end{center}
\end{figure*}

From the output of these sample inputs, as well as other input images from the dataset, it seems that using NCC to align the photos would result in more well-aligned output photos. Though SSD requires a lot less computation, SSD is more likely to produce skewed results, making NCC the more reliable choice.

\end{homeworkProblem}
\clearpage
%----------------------------------------------------------------------------------------
%   PROBLEM 3
%----------------------------------------------------------------------------------------

\begin{homeworkProblem}
\textit{Applying the problem to larger inputs from the dataset.}

%The technique from Part 1 will only work for small images, and will take too long for larger images. This problem can be solved by rescaling the images with scipy.misc.imresize(), matching the small versions of the images to obtain a rough estimate of the match, and only then matching the large versions of the images. This procedure could be repeated several times. Implement matching so that it works for larger images as well. In the report, describe your results and the runtimes that you obtain.

Earlier, in the description of the dataset, higher-resolution \emph{.png} files were mentioned, but were not dealt with in Part 1 of this assignment. The approach from Part 1 would not produce accurate results for this part of the dataset, due to the discrepancy in size: we would need to test alignments for displacements that are more proportional to the images (10 pixels is not enough). However, making the computations with either method for that amount of displacements would be extremely time-consuming. Therefore, the higher-resolution images will be aligned using an image pyramid, a series that consists of the same image increasing in resolution, coming to its original size at the end (bottom) of the pyramid.  

The smaller resolution images in the pyramid will be used to obtain an estimation for the correct displacement, and scores will be taken from the larger images based on the displacement from the smaller images. In my implementation, the pyramid went as small as going to some percentage of the original image width (3\%, to be exact), using NCC to incrementally align the images until we got to the full resolution image. At each increase in resolution, we would decrease the range of displacements to check alignments for (because at higher resolutions, checking more displacements can be costly). 

The results turned out decent for most images. Not all images were perfectly aligned, but usually only missed by a tiny displacement. Some sample output images (including some comments) can be found in in Figure~\ref{fig:part2output}.

I will estimate an upper-bound for the runtime of this implementation using data from part 1. Considering that running NCC on a lower-resolution file takes about 1 time unit (in my case, my test run was about a second). I predict that because the larger resolution images are about 10 times larger in height and width, I would simply take this time unit and multiply by 100 (first by 10 for height, and then another 10 for width). Though the method for the higher resolution images requires more steps, I believe they balance each other out. For example, though in the lowest level of the pyramid, we are looking at an image that is 10 times as large as the lower resolution images, we are also taking less displacements, which will shave off a bit of time that we can use to find the many displacements for the higher levels on the pyramid. If each time unit is one second, as it was for my own testing, then the runtime for running this method would be about $100 seconds \approx 1.67 minutes$.

\iffalse
OUTPUT FROM TESTS (MacBook Pro running OS X 10.9.5; 3GHz Intel Core i7; 8GB memory)
> part1(00106v.jpg, <function ncc at 0x111f55aa0>): 0.92129611969 seconds
> part2(00128u.png, 10): 1.57219223579 minutes
> part2(01047u.png, 10): 1.60740085045 minutes
> part2(00458u.png, 10): 1.58106016715 minutes
> part2(00822u.png, 10): 1.73020026684 minutes
\fi

\begin{figure*}[h!]
    \begin{center}
    \begin{subfigure}[b]{0.5\textwidth}
        \displayImage{00128u_part2out.jpg}{0.4}
        \caption{Runtime: 1.57219223579 minutes.}
    \end{subfigure}%
    ~
    \begin{subfigure}[b]{0.5\textwidth}
        \displayImage{01047u_part2out.jpg}{0.4}
        \caption{Runtime: 1.60740085045 minutes.}
    \end{subfigure}
    
    \begin{subfigure}[t]{0.5\textwidth}
        \displayImage{00458u_part2out.jpg}{0.4}
        \caption{Runtime: 1.58106016715 minutes. Note that upon close inspection, the channels are slightly misaligned.}
    \end{subfigure}%
    ~
    \begin{subfigure}[t]{0.5\textwidth}
        \displayImage{00822u_part2out.jpg}{0.4}
        \caption{Runtime: 1.73020026684 minutes. Here, the channels are actually noticably misaligned in actual size. I speculate that maybe there was, at one point, a time where multiple displacements produced the highest score, but my implementation chose one that does not actually align.}
    \end{subfigure}
    \end{center}
    \caption{High-resolution sample output photos.}
    \label{fig:part2output}
\end{figure*}

\end{homeworkProblem}
\clearpage

\end{document}